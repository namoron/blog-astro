---
layout: ../../../../layouts/MarkdownPostLayout.astro
title: CPUæ¸©åº¦ã‚’ãƒ¡ãƒ¼ãƒ«ã§çŸ¥ã‚‰ã›ã‚‹
author: namor
# description: "This post will show up on its own!"
img: /2023/cpuTemp/overview.jpeg
img_alt: ""
pubDate: "2023-12-27"
tags: ["software"]
---

### ãã£ã‹ã‘

æœ€è¿‘,ãƒ©ãƒƒã‚¯ãƒã‚¦ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼(PowerEdgeR720xd)ã‚’æ‰‹ã«å…¥ã‚Œã¦å®¶ã§é‹ç”¨ã—å§‹ã‚ã¾ã—ãŸ.ã§ã™ãŒ,ãƒ•ã‚¡ãƒ³ã®ãƒã‚¤ã‚ºãŒå‰²ã‚Šã¨ã†ã‚‹ã•ã„ã§ã™.

ãã“ã§ãƒ•ã‚¡ãƒ³ã®é€Ÿåº¦ã‚’ 10 %ã«ä¸‹ã’ã¦ã¿ãŸã®ã§ã™ãŒ,ä»Šåº¦ã¯ CPU æ¸©åº¦ãŒä¸ŠãŒã£ã¦ç†±æš´èµ°ã—ãŸã‚‰ã©ã†ã—ã‚ˆï¼Ÿã¨ãªã‚Š,æ¸©åº¦ãŒè¨­å®šã‚’è¶…ãˆãŸã‚‰ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œã‚Šã¾ã—ãŸ.

### ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹

ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡éƒ¨åˆ†ã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¾ã—ãŸ. [Python ã§ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡](https://zenn.dev/shimakaze_soft/articles/9601818a95309c)

ã©ã†ã‚„ã‚‰ Gmail ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é–¢ä¿‚ã§,ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã§ã¯ãªã,OAuth2.0 ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ã§ã“ã¡ã‚‰ã‚‚å‚è€ƒã«ã—ã¾ã—ãŸ.[Python ã§ãƒ¡ãƒ¼ãƒ«(gmail)ã‚’é€ä¿¡ã§ããªã„å ´åˆã®è§£æ±ºæ³•](https://www.gocca.work/python-mailerror/)

### CPU æ¸©åº¦ã‚’å–å¾—ã™ã‚‹

æ¸©åº¦ã¯,`lm-sensors`ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã§ `sensors`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦å–å¾—ã—ã¾ã—ãŸ.
[lm-sensors](https://kaworu.jpn.org/ubuntu/lm-sensors)

### ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œ

`crontab`ã‚’ä½¿ã£ã¦,1 æ™‚é–“ã«ä¸€å›å®šæœŸçš„ã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ.

```bash
# crontab -e
0 */1 * * * python3 /root/cpuTemperature/cpu.py
```

### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```python
import ssl
import subprocess
import time
from smtplib import SMTP_SSL

from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText

TEMP_THRESHOLD = 70

def get_cpu_temperature():
    # ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
    result = subprocess.run(["sensors | grep 'Package id 0' | awk '{print $4}' | cut -c 2-3"], stdout=subprocess.PIPE, shell=True)
    # çµæœã‚’æ–‡å­—åˆ—ã¨ã—ã¦å–å¾—ã€æ•´æ•°å€¤ã«å¤‰æ›
    temp = int(result.stdout.strip())
    return temp

def create_mail_message_mime(from_email, to_email, message, subject, filepath=None, filename=""):
    # MIMETextã‚’ä½œæˆ
    msg = MIMEMultipart()
    msg['Subject'] = subject
    msg['From'] = from_email
    msg['To'] = to_email
    msg.attach(MIMEText(message, 'plain', 'utf-8'))
    return msg

def send_email(msg):
    account = "             @gmail.com"  # è‡ªåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    password = "                  "   # ç”Ÿæˆã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

    host = 'smtp.gmail.com'
    port = 465

    context = ssl.create_default_context()
    server = SMTP_SSL(host, port, context=context)

    server.login(account, password)

    server.send_message(msg)

    server.quit()

def main():
    temp = get_cpu_temperature()
    if temp >= TEMP_THRESHOLD:
        # ãƒ¡ãƒ¼ãƒ«ã®é€ã‚Šä¸»
        from_email = "                          "

        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ˆ
        to_email = "                             "

        subject = "[è­¦å‘Š!]ã‚µãƒ¼ãƒãƒ¼ã®æ¸©åº¦ç•°å¸¸"
        message = f"è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã®CPUæ¸©åº¦ãŒ{temp}åº¦ã§ã™."

        # MIMEå½¢å¼ã®ä½œæˆ
        mime = create_mail_message_mime(from_email, to_email, message, subject)

        # ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡
        send_email(mime)

if __name__ == "__main__":
    main()
```

### å®Ÿè¡Œçµæœ

<div align="center">
  <img src="/2023/cpuTemp/mail.jpg" alt="" />
  <p>ãƒ¡ãƒ¼ãƒ«ã«æ¥ã‚‹ãŠçŸ¥ã‚‰ã›(ãƒ‡ãƒ¢)</p>
</div>

### ã¾ã¨ã‚

ã„ã„æ„Ÿã˜ã«å‹•ãã¾ã—ãŸ"ğŸ‘"
